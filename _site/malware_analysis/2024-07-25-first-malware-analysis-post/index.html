<!doctype html>
<!--
  Minimal Mistakes Jekyll Theme 4.26.2 by Michael Rose
  Copyright 2013-2024 Michael Rose - mademistakes.com | @mmistakes
  Free for personal and commercial use under the MIT license
  https://github.com/mmistakes/minimal-mistakes/blob/master/LICENSE
-->

<html lang="en" class="no-js">
  <head>
    <meta charset="utf-8">

<!-- begin _includes/seo.html --><title>Attacking Android Malware with Frida - Desktop and Mobile Malware Analysis</title>
<meta name="description" content="In this blog post, I will showcase how Frida, a popular dynamic instrumentation framework, can be utilized for Android malware analysis across three distinct real world malware samples.">


  <meta name="author" content="Urban Vidergar">
  
  <meta property="article:author" content="Urban Vidergar">
  


<meta property="og:type" content="article">
<meta property="og:locale" content="en_US">
<meta property="og:site_name" content="Desktop and Mobile Malware Analysis">
<meta property="og:title" content="Attacking Android Malware with Frida">
<meta property="og:url" content="http://localhost:4000/malware_analysis/2024-07-25-first-malware-analysis-post/">


  <meta property="og:description" content="In this blog post, I will showcase how Frida, a popular dynamic instrumentation framework, can be utilized for Android malware analysis across three distinct real world malware samples.">







  <meta property="article:published_time" content="2024-07-25T08:00:00-04:00">






<link rel="canonical" href="http://localhost:4000/malware_analysis/2024-07-25-first-malware-analysis-post/">












<!-- end _includes/seo.html -->



  <link href="/feed.xml" type="application/atom+xml" rel="alternate" title="Desktop and Mobile Malware Analysis Feed">
<meta name="viewport" content="width=device-width, initial-scale=1.0">

<script type="text/javascript">
  document.documentElement.className = document.documentElement.className.replace(/\bno-js\b/g, '') + ' js ';
  
</script>

<!-- For all browsers -->
<link rel="stylesheet" href="/assets/css/main.css">
<link rel="preload" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@latest/css/all.min.css" as="style" onload="this.onload=null;this.rel='stylesheet'">
<noscript><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@latest/css/all.min.css"></noscript>



    <!-- start custom head snippets -->

<!-- insert favicons. use https://realfavicongenerator.net/ -->

<!-- end custom head snippets -->

  </head>

  <body class="layout--single">
    <nav class="skip-links">
  <ul>
    <li><a href="#site-nav" class="screen-reader-shortcut">Skip to primary navigation</a></li>
    <li><a href="#main" class="screen-reader-shortcut">Skip to content</a></li>
    <li><a href="#footer" class="screen-reader-shortcut">Skip to footer</a></li>
  </ul>
</nav>

    

<div class="masthead">
  <div class="masthead__inner-wrap">
    <div class="masthead__menu">
      <nav id="site-nav" class="greedy-nav">
        
        <a class="site-title" href="/">
          Desktop and Mobile Malware Analysis
          
        </a>
        <ul class="visible-links"></ul>
        
        <button class="greedy-nav__toggle hidden" type="button">
          <span class="visually-hidden">Toggle menu</span>
          <div class="navicon"></div>
        </button>
        <ul class="hidden-links hidden"></ul>
      </nav>
    </div>
  </div>
</div>


    <div class="initial-content">
      





<div id="main" role="main">
  
  <div class="sidebar sticky">
  


<div itemscope itemtype="https://schema.org/Person" class="h-card">

  
    <div class="author__avatar">
      <a href="http://localhost:4000/">
        <img src="https://www.infosek.net/images1/Urban%20Vidergar.jpg" alt="Urban Vidergar" itemprop="image" class="u-photo">
      </a>
    </div>
  

  <div class="author__content">
    <h3 class="author__name p-name" itemprop="name">
      <a class="u-url" rel="me" href="http://localhost:4000/" itemprop="url">Urban Vidergar</a>
    </h3>
    
      <div class="author__bio p-note" itemprop="description">
        <p>Malware Reverse Engineer</p>

      </div>
    
  </div>

  <div class="author__urls-wrapper">
    <button class="btn btn--inverse">Follow</button>
    <ul class="author__urls social-icons">
      
        <li itemprop="homeLocation" itemscope itemtype="https://schema.org/Place">
          <i class="fas fa-fw fa-map-marker-alt" aria-hidden="true"></i> <span itemprop="name" class="p-locality">Ljubljana, Slovenia</span>
        </li>
      

      
        
          
        
      

      

      

      

      

      

      

      

      

      

      

      

      

      

      

      

      

      

      

      

      

      

      

      

      

      <!--
  <li>
    <a href="http://link-to-whatever-social-network.com/user/" itemprop="sameAs" rel="nofollow noopener noreferrer me">
      <i class="fas fa-fw" aria-hidden="true"></i> Custom Social Profile Link
    </a>
  </li>
-->
    </ul>
  </div>
</div>

  
  </div>



  <article class="page" itemscope itemtype="https://schema.org/CreativeWork">
    <meta itemprop="headline" content="Attacking Android Malware with Frida">
    <meta itemprop="description" content="In this blog post, I will showcase how Frida, a popular dynamic instrumentation framework, can be utilized for Android malware analysis across three distinct real world malware samples.">
    <meta itemprop="datePublished" content="2024-07-25T08:00:00-04:00">
    

    <div class="page__inner-wrap">
      
        <header>
          <h1 id="page-title" class="page__title" itemprop="headline">
            <a href="http://localhost:4000/malware_analysis/2024-07-25-first-malware-analysis-post/" itemprop="url">Attacking Android Malware with Frida
</a>
          </h1>
          


        </header>
      

      <section class="page__content" itemprop="text">
        
          <aside class="sidebar__right ">
            <nav class="toc">
              <header><h4 class="nav__title"><i class="fas fa-align-justify"></i> Table of Contents</h4></header>
              <ul class="toc__menu"><li><a href="#what-is-frida">What is Frida?</a></li><li><a href="#how-does-frida-work-and-how-to-use-it-on-malware-samples">How does Frida work and how to use it on malware samples?</a></li><li><a href="#hooking-native-functions-to-intercept-arguments-for-one-time-executed-functions">Hooking Native Functions to Intercept Arguments for One-Time Executed Functions</a></li><li><a href="#finally-hooking-native-function">Finally hooking native function</a></li><li><a href="#manually-invoking-decryption-methods-or-native-functions">Manually invoking decryption methods or native functions</a></li><li><a href="#using-frida-scripts-with-python-wrapper">Using Frida scripts with Python wrapper</a></li><li><a href="#conclusion">Conclusion</a></li></ul>
            </nav>
          </aside>
        
        <p>In this blog post, I will showcase how Frida, a popular dynamic instrumentation framework, can be utilized for Android malware analysis across three distinct real world malware samples.</p>

<h2 id="what-is-frida">What is Frida?</h2>
<p>Even while being predominantly recognized as a mobile application pentesting utility, Frida proves equally effective in mobile malware analysis and is particularly useful for  validating findings from the static analysis phase of the applications examination process.</p>

<h2 id="how-does-frida-work-and-how-to-use-it-on-malware-samples">How does Frida work and how to use it on malware samples?</h2>

<p>Frida operates by injecting custom-written JavaScript (or Python) scripts into the application’s process, effectively manipulating loaded methods or even native functions. This functionality includes inspecting or changing passed arguments and function’s return values, invoking methods on existing or newly created objects, as well as altering static variables and much more. The goal of this article is to present a subset of these features for malware analysis purposes. This article explores the following use cases:</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>1.	Hooking Native Functions to Intercept Arguments for One-Time Executed Functions
2.	Manually Invoking Native Methods for String Decryption
3.	Utilizing Wrapper Scripts
</code></pre></div></div>

<h2 id="hooking-native-functions-to-intercept-arguments-for-one-time-executed-functions">Hooking Native Functions to Intercept Arguments for One-Time Executed Functions</h2>

<p>This section explains the dynamic analysis process of an Android malware sample belonging to the Kangapack family, which was first discovered, analyzed and named by the security researcher <a href="https://cryptax.medium.com/inside-kangapack-the-kangaroo-packer-with-native-decryption-3e7e054679c4">Cryptax</a>. While the comprehensive analysis of this native malware packer, which stores its encrypted malicious payload in the file classes.dex, is beyond the scope of this blog post, I will demonstrate how Frida framework with provided scripts can be used to intercept AES decryption arguments used for decrypting its malicious classes, also known as the payload. All scripts are available in my github repo and malware hashes used in analysis are provided at the IoC section.</p>

<p>The main objective of this subsection is to identify the appropriate point in the application’s execution workflow to intercept the AES decryption arguments – it’s initialization vector and the decryption key needed for manual decryption of the malicious payload. Frida offers powerful capabilities for hooking into both Java and native layer methods and functions. For intercepting the decryption parameters in question, of particular interest is the AES decryption function EVP_DecryptInit_ex, an exported function from the OpenSSL library, operating at a native layer. Frida’s Interceptor.attach module allows us to dynamically hook under its hood during its execution and retrieve the desired arguments needed in malware analysis.
Simply running the script and hooking into this function won’t yield desired results, as the corresponding native library with targeted exported native function needs to be loaded into the memory first. The Android’s APIs responsible for dynamic library loading are System.loadLibrary and System.load, both of which call the operating system’s loader to load the provided native library in the memory. The simplest solution to avoid hooking undefined functions is introducing a hardcoded timing delay before the function hooking. In this case, however, implementing a delay isn’t a feasible solution since the AES decryption parameters are used only once and delaying would result in missing the appropriate moment of functions execution. Since the decryption function is only executed once during the whole payload decryption process, it is crucial to hook the function before its execution to intercept decryption arguments with the decryption key and initialization vector.</p>

<p>To achieve this, some additional context and further analysis is needed. Dynamic analysis reveals that the native method abcdesCrypt is responsible for the decryption process.  This method handles the AES decryption process, thereby decrypting the malicious classes. As seen from the first screenshot, in the same class API for loading libraries is called. We must ensure this class is instantiated by the time we execute our hook.</p>

<p><img src="https://i.imgur.com/YWbaHpZ.png" alt="Loading of the library in the same class" /></p>

<p>Method abcdesCrypt is the last decryption method in the Java layer. Its further implementation is located in compiled library and takes care of AES decryption process that decrypts malicious classes we call the payload. 
The purpose of this article is to present how to identify the appropriate point in execution flow of app for desired purposes – in this case to intercept AES IV and the decryption key.</p>

<p>Hooking the Java method using the script <a href="https://github.com/urban5/Frida-for-Android-Malware-Analysis/blob/main/logCallStack.js">logCallStack.js</a>, which prints the call stack to identify the external function that called it, ensuring the library is loaded in memory before the method is called.</p>

<p><img src="https://i.imgur.com/upgRwrl.png" alt="Call stack" /></p>

<p>Static analysis also confirms we found the first wrapping method.</p>

<p><img src="https://i.imgur.com/Kf4aJ43.png" alt="Call stack" /></p>

<p>Additionaly, callgraph createad by  reveals the same chain of method calls that helps us find the right point in execution flow to attach the hooking script.</p>

<p>Additionally, callgraph created by <a href="https://github.com/androguard/androguard">Androguard</a> confirms the same execution chain as analyzed with Frida. Because the native library is loaded in the same class as native method is called from, we conduct that method abcdesCrypt is appropriate method to inject into. To confirm that library is loaded, we use the <a href="https://github.com/urban5/Frida-for-Android-Malware-Analysis/blob/main/monitorLibraryLoad.js">monitorLibraryLoad.js script</a>, which checks loading status of a tageted native library before and after method’s execution, effectively checking whether selected method acts as a boundary point for successful hooking into the library’s native function.</p>

<p><img src="https://i.imgur.com/hWIBqwE.png" alt="Call Graph" /></p>

<p>Note that hooking a wrapping method is not the only way to hook native functions, as native function dl_open can also be intercepted. More on this in the future post about unpacking native Android packers and protectors.</p>

<p>All of the previous scripts helped us find the right point in application execution flow to hook AES decryption function implemented in native layer. The final script first hooks into the wrapping Java method, checks whether corresponding native library is loaded into memory,  hooks into AES decryption function EVP_DecryptInit_ex and outputs its decryption arguments – the decryption key and initialization vector.</p>

<h2 id="finally-hooking-native-function">Finally hooking native function</h2>
<p>Once we identify the appropriate point to hook the native function, we can intercept the initialization function responsible for AES decryption of the payload and output the decryption key and initialization vector. Here is the final script that hooks the wrapping Java method to ensure the library is loaded, then hooks the native function, and intercepts the decryption parameters:
Here is the final script that hook the wrapping Java method to ensure lbrary is loaded and then hooks native function and intercepts the decryprion parameters. Script is also accessible on <a href="https://github.com/urban5/Frida-for-Android-Malware-Analysis/blob/main/hookAESDecryption.js">Github</a>.</p>

<div class="language-javascript highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nx">Java</span><span class="p">.</span><span class="nx">perform</span><span class="p">(</span><span class="kd">function</span> <span class="p">()</span> <span class="p">{</span>
    <span class="c1">// Configuration</span>
    <span class="kd">var</span> <span class="nx">targetClass</span> <span class="o">=</span> <span class="dl">'</span><span class="s1">com.hwgapkspv.gouhwkh.Molfwernpozxswfsg</span><span class="dl">'</span><span class="p">;</span>
    <span class="kd">var</span> <span class="nx">targetMethod</span> <span class="o">=</span> <span class="dl">'</span><span class="s1">abcdesCrypt</span><span class="dl">'</span><span class="p">;</span>
    <span class="kd">var</span> <span class="nx">libraryName</span> <span class="o">=</span> <span class="dl">'</span><span class="s1">libapksadfsalkwes.so</span><span class="dl">'</span><span class="p">;</span>
    <span class="kd">var</span> <span class="nx">nativeMethodSignature</span> <span class="o">=</span> <span class="dl">'</span><span class="s1">[B</span><span class="dl">'</span><span class="p">;</span>

    <span class="c1">// Helper function to check if the library is loaded</span>
    <span class="kd">function</span> <span class="nx">isLibraryLoaded</span><span class="p">(</span><span class="nx">libName</span><span class="p">)</span> <span class="p">{</span>
        <span class="kd">var</span> <span class="nx">modules</span> <span class="o">=</span> <span class="nx">Process</span><span class="p">.</span><span class="nx">enumerateModules</span><span class="p">();</span>
        <span class="k">for</span> <span class="p">(</span><span class="kd">var</span> <span class="nx">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="nx">i</span> <span class="o">&lt;</span> <span class="nx">modules</span><span class="p">.</span><span class="nx">length</span><span class="p">;</span> <span class="nx">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
            <span class="k">if</span> <span class="p">(</span><span class="nx">modules</span><span class="p">[</span><span class="nx">i</span><span class="p">].</span><span class="nx">name</span> <span class="o">===</span> <span class="nx">libName</span><span class="p">)</span> <span class="p">{</span>
                <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="s2">`[INFO] Library </span><span class="p">${</span><span class="nx">libName</span><span class="p">}</span><span class="s2"> is loaded.`</span><span class="p">);</span>
                <span class="k">return</span> <span class="kc">true</span><span class="p">;</span>
            <span class="p">}</span>
        <span class="p">}</span>
        <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="s2">`[INFO] Library </span><span class="p">${</span><span class="nx">libName</span><span class="p">}</span><span class="s2"> is not loaded.`</span><span class="p">);</span>
        <span class="k">return</span> <span class="kc">false</span><span class="p">;</span>
    <span class="p">}</span>

    <span class="c1">// Hook the Java method</span>
    <span class="kd">var</span> <span class="nx">targetClassInstance</span> <span class="o">=</span> <span class="nx">Java</span><span class="p">.</span><span class="nx">use</span><span class="p">(</span><span class="nx">targetClass</span><span class="p">);</span>
    <span class="nx">targetClassInstance</span><span class="p">[</span><span class="nx">targetMethod</span><span class="p">].</span><span class="nx">overload</span><span class="p">(</span><span class="nx">nativeMethodSignature</span><span class="p">).</span><span class="nx">implementation</span> <span class="o">=</span> <span class="kd">function</span> <span class="p">(</span><span class="nx">arg0</span><span class="p">)</span> <span class="p">{</span>
        <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="s2">`[INFO] Hooked method </span><span class="p">${</span><span class="nx">targetClass</span><span class="p">}</span><span class="s2">.</span><span class="p">${</span><span class="nx">targetMethod</span><span class="p">}</span><span class="s2">`</span><span class="p">);</span>

        <span class="c1">// Check if the library is loaded before the method call</span>
        <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="dl">'</span><span class="s1">[INFO] Checking library before method call:</span><span class="dl">'</span><span class="p">);</span>
        <span class="nx">isLibraryLoaded</span><span class="p">(</span><span class="nx">libraryName</span><span class="p">);</span>

        <span class="c1">// Function to enumerate imports and attach to EVP_DecryptInit_ex</span>
        <span class="kd">function</span> <span class="nx">enumerateAndAttach</span><span class="p">()</span> <span class="p">{</span>
            <span class="kd">var</span> <span class="nx">decryptAddress</span> <span class="o">=</span> <span class="kc">null</span><span class="p">;</span>
            <span class="kd">var</span> <span class="nx">imports</span> <span class="o">=</span> <span class="nx">Module</span><span class="p">.</span><span class="nx">enumerateImportsSync</span><span class="p">(</span><span class="nx">libraryName</span><span class="p">);</span>

            <span class="k">for</span> <span class="p">(</span><span class="kd">var</span> <span class="nx">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="nx">i</span> <span class="o">&lt;</span> <span class="nx">imports</span><span class="p">.</span><span class="nx">length</span><span class="p">;</span> <span class="nx">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
                <span class="k">if</span> <span class="p">(</span><span class="nx">imports</span><span class="p">[</span><span class="nx">i</span><span class="p">].</span><span class="nx">name</span> <span class="o">===</span> <span class="dl">"</span><span class="s2">EVP_DecryptInit_ex</span><span class="dl">"</span><span class="p">)</span> <span class="p">{</span>
                    <span class="nx">decryptAddress</span> <span class="o">=</span> <span class="nx">imports</span><span class="p">[</span><span class="nx">i</span><span class="p">].</span><span class="nx">address</span><span class="p">;</span>
                    <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="dl">"</span><span class="s2">Found import EVP_DecryptInit_ex at address: </span><span class="dl">"</span> <span class="o">+</span> <span class="nx">decryptAddress</span><span class="p">);</span>
                    <span class="k">break</span><span class="p">;</span>
                <span class="p">}</span>
            <span class="p">}</span>

            <span class="k">if</span> <span class="p">(</span><span class="nx">decryptAddress</span><span class="p">)</span> <span class="p">{</span>
                <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="dl">"</span><span class="s2">Attaching to EVP_DecryptInit_ex at address: </span><span class="dl">"</span> <span class="o">+</span> <span class="nx">decryptAddress</span><span class="p">);</span>
                <span class="nx">Interceptor</span><span class="p">.</span><span class="nx">attach</span><span class="p">(</span><span class="nx">decryptAddress</span><span class="p">,</span> <span class="p">{</span>
                    <span class="na">onEnter</span><span class="p">:</span> <span class="kd">function</span> <span class="p">(</span><span class="nx">args</span><span class="p">)</span> <span class="p">{</span>
                        <span class="kd">var</span> <span class="nx">keyArgument</span> <span class="o">=</span> <span class="nx">Memory</span><span class="p">.</span><span class="nx">readByteArray</span><span class="p">(</span><span class="nx">ptr</span><span class="p">(</span><span class="nx">args</span><span class="p">[</span><span class="mi">3</span><span class="p">]),</span> <span class="mi">32</span><span class="p">);</span>
                        <span class="kd">var</span> <span class="nx">keyHexDump</span> <span class="o">=</span> <span class="nx">hexdump</span><span class="p">(</span><span class="nx">keyArgument</span><span class="p">,</span> <span class="p">{</span> <span class="na">offset</span><span class="p">:</span> <span class="mi">0</span><span class="p">,</span> <span class="na">length</span><span class="p">:</span> <span class="mi">32</span><span class="p">,</span> <span class="na">header</span><span class="p">:</span> <span class="kc">true</span><span class="p">,</span> <span class="na">ansi</span><span class="p">:</span> <span class="kc">true</span> <span class="p">});</span>

                        <span class="kd">var</span> <span class="nx">keyMessage</span> <span class="o">=</span> <span class="dl">"</span><span class="s2">[*] AES Key </span><span class="dl">"</span> <span class="o">+</span> <span class="mi">3</span> <span class="o">+</span> <span class="dl">"</span><span class="s2"> </span><span class="dl">"</span> <span class="o">+</span> <span class="nx">args</span><span class="p">[</span><span class="mi">3</span><span class="p">];</span>
                        <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="nx">keyMessage</span><span class="p">);</span>
                        <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="nx">keyHexDump</span><span class="p">);</span>

                        <span class="kd">var</span> <span class="nx">ivArgument</span> <span class="o">=</span> <span class="nx">Memory</span><span class="p">.</span><span class="nx">readByteArray</span><span class="p">(</span><span class="nx">ptr</span><span class="p">(</span><span class="nx">args</span><span class="p">[</span><span class="mi">4</span><span class="p">]),</span> <span class="mi">16</span><span class="p">);</span>
                        <span class="kd">var</span> <span class="nx">ivHexDump</span> <span class="o">=</span> <span class="nx">hexdump</span><span class="p">(</span><span class="nx">ivArgument</span><span class="p">,</span> <span class="p">{</span> <span class="na">offset</span><span class="p">:</span> <span class="mi">0</span><span class="p">,</span> <span class="na">length</span><span class="p">:</span> <span class="mi">16</span><span class="p">,</span> <span class="na">header</span><span class="p">:</span> <span class="kc">true</span><span class="p">,</span> <span class="na">ansi</span><span class="p">:</span> <span class="kc">true</span> <span class="p">});</span>

                        <span class="kd">var</span> <span class="nx">ivMessage</span> <span class="o">=</span> <span class="dl">"</span><span class="s2">[*] AES IV </span><span class="dl">"</span> <span class="o">+</span> <span class="mi">4</span> <span class="o">+</span> <span class="dl">"</span><span class="s2"> </span><span class="dl">"</span> <span class="o">+</span> <span class="nx">args</span><span class="p">[</span><span class="mi">4</span><span class="p">];</span>
                        <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="nx">ivMessage</span><span class="p">);</span>
                        <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="nx">ivHexDump</span><span class="p">);</span>
                    <span class="p">}</span>
                <span class="p">});</span>
            <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
                <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="dl">"</span><span class="s2">EVP_DecryptInit_ex not found in imports.</span><span class="dl">"</span><span class="p">);</span>
            <span class="p">}</span>
        <span class="p">}</span>

        <span class="c1">// Call the enumeration and attachment function before the method execution</span>
        <span class="nx">enumerateAndAttach</span><span class="p">();</span>

        <span class="c1">// Call the original method and capture the return value</span>
        <span class="kd">var</span> <span class="nx">result</span> <span class="o">=</span> <span class="k">this</span><span class="p">[</span><span class="nx">targetMethod</span><span class="p">](</span><span class="nx">arg0</span><span class="p">);</span>

        <span class="c1">// Check if the library is loaded after the method call</span>
        <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="dl">'</span><span class="s1">[INFO] Checking library after method call:</span><span class="dl">'</span><span class="p">);</span>
        <span class="nx">isLibraryLoaded</span><span class="p">(</span><span class="nx">libraryName</span><span class="p">);</span>

        <span class="k">return</span> <span class="nx">result</span><span class="p">;</span>
    <span class="p">};</span>
<span class="p">});</span>
</code></pre></div></div>

<h2 id="manually-invoking-decryption-methods-or-native-functions">Manually invoking decryption methods or native functions</h2>

<p>When analyzing Android malware, we often inspect methods that decrypt strings by accepting another value like an encrypted string or integer as a parameter. In those cases, it is not particularly important whether we intercept the decrypted string or retrieve it ourselves. Frida framework can be used not only to intercept function arguments, but also to manually call methods and functions at any given time with the desired arguments. 
Packer Jiagu, one of the most commonly used protectors for malware applications, is known for employing decryption routines decrypting strings from passed integers in the native layer. Static string decryption is particularly complex and will be addressed in a future blog post focusing on native unpacking techniques In this analysis, we opted for dynamic string decryption by identifying the decryption method implemented in the native layer and manually invoking it.</p>

<p><img src="https://i.imgur.com/FMlhhRl.png" alt="String decryption with Frida" /></p>

<p>The revealed strings in the shown example demonstrate that the application payload functions as a banking trojan, targeting and stealing cryptocurrency wallet information.</p>

<h2 id="using-frida-scripts-with-python-wrapper">Using Frida scripts with Python wrapper</h2>

<p>Analyzing some samples from a widely distributed Anubis family can sometimes triggers an error, causing the application to exit with the message: “Failed to spawn: unable to find front-door activity.”, effectively disabling Frida from the malware analysis process.
Although the Launcher activity is declared in the application’s AndroidManifest.xml file and the corresponding code is present in the APK file, the app fails to start with Frida alone. To successfully start the application and hook into its methods, a Python <a href="https://github.com/urban5/Frida-for-Android-Malware-Analysis/blob/main/wrapper.py">wrapping script</a> is required.</p>

<p><img src="https://i.imgur.com/C6j0gME.png" alt="&quot;Failed to spawn: unable to find front-door activity&quot; error" /></p>

<p>This wrapper script facilitates the attachment of a Frida script to applications process that encounter “Failed to spawn: unable to find front-door activity”  error. It continuously monitors for the application to be manually opened by the user, either via the app drawer or ADB, and once the app is detected as running, the Frida script is automatically attached to the application process.</p>

<p><img src="https://i.imgur.com/LjymF7G.png" alt="Wrapper for resolving &quot;Failed to spawn: unable to find front-door activity&quot; error" /></p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="p">(</span><span class="n">IWebmService_interface</span><span class="o">-&gt;</span><span class="n">lpVtbl</span><span class="o">-&gt;</span><span class="n">ExecMethod</span><span class="p">)(</span>
          <span class="n">IWebmService_interface</span><span class="p">,</span>
          <span class="n">Win32_process_string</span><span class="p">,</span> <span class="o">//</span> <span class="n">Win32_Process</span>
          <span class="mi">0</span><span class="p">,</span>
          <span class="mi">7</span><span class="p">,</span>
          <span class="mi">0</span><span class="p">,</span>
          <span class="n">IWbemClassObject_interface_ref</span><span class="p">,</span>
          <span class="o">&amp;</span><span class="n">Zero</span><span class="p">,</span>
          <span class="mi">0</span><span class="p">);</span>
</code></pre></div></div>

<p>Primer JS kode:</p>
<div class="language-javascript highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nx">Java</span><span class="p">.</span><span class="nx">perform</span><span class="p">(</span><span class="kd">function</span> <span class="p">()</span> <span class="p">{</span>
    <span class="c1">// Configuration</span>
    <span class="kd">var</span> <span class="nx">targetClass</span> <span class="o">=</span> <span class="dl">'</span><span class="s1">com.hwgapkspv.gouhwkh.Molfwernpozxswfsg</span><span class="dl">'</span><span class="p">;</span>
    <span class="kd">var</span> <span class="nx">targetMethod</span> <span class="o">=</span> <span class="dl">'</span><span class="s1">abcdesCrypt</span><span class="dl">'</span><span class="p">;</span>
    <span class="kd">var</span> <span class="nx">libraryName</span> <span class="o">=</span> <span class="dl">'</span><span class="s1">libapksadfsalkwes.so</span><span class="dl">'</span><span class="p">;</span>
    <span class="kd">var</span> <span class="nx">nativeMethodSignature</span> <span class="o">=</span> <span class="dl">'</span><span class="s1">[B</span><span class="dl">'</span><span class="p">;</span>

    <span class="c1">// Helper function to check if the library is loaded</span>
    <span class="kd">function</span> <span class="nx">isLibraryLoaded</span><span class="p">(</span><span class="nx">libName</span><span class="p">)</span> <span class="p">{</span>
        <span class="kd">var</span> <span class="nx">modules</span> <span class="o">=</span> <span class="nx">Process</span><span class="p">.</span><span class="nx">enumerateModules</span><span class="p">();</span>
        <span class="k">for</span> <span class="p">(</span><span class="kd">var</span> <span class="nx">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="nx">i</span> <span class="o">&lt;</span> <span class="nx">modules</span><span class="p">.</span><span class="nx">length</span><span class="p">;</span> <span class="nx">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
            <span class="k">if</span> <span class="p">(</span><span class="nx">modules</span><span class="p">[</span><span class="nx">i</span><span class="p">].</span><span class="nx">name</span> <span class="o">===</span> <span class="nx">libName</span><span class="p">)</span> <span class="p">{</span>
                <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="s2">`[INFO] Library </span><span class="p">${</span><span class="nx">libName</span><span class="p">}</span><span class="s2"> is loaded.`</span><span class="p">);</span>
                <span class="k">return</span> <span class="kc">true</span><span class="p">;</span>
            <span class="p">}</span>
        <span class="p">}</span>
        <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="s2">`[INFO] Library </span><span class="p">${</span><span class="nx">libName</span><span class="p">}</span><span class="s2"> is not loaded.`</span><span class="p">);</span>
        <span class="k">return</span> <span class="kc">false</span><span class="p">;</span>
    <span class="p">}</span>

    <span class="c1">// Hook the Java method</span>
    <span class="kd">var</span> <span class="nx">targetClassInstance</span> <span class="o">=</span> <span class="nx">Java</span><span class="p">.</span><span class="nx">use</span><span class="p">(</span><span class="nx">targetClass</span><span class="p">);</span>
    <span class="nx">targetClassInstance</span><span class="p">[</span><span class="nx">targetMethod</span><span class="p">].</span><span class="nx">overload</span><span class="p">(</span><span class="nx">nativeMethodSignature</span><span class="p">).</span><span class="nx">implementation</span> <span class="o">=</span> <span class="kd">function</span> <span class="p">(</span><span class="nx">arg0</span><span class="p">)</span> <span class="p">{</span>
        <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="s2">`[INFO] Hooked method </span><span class="p">${</span><span class="nx">targetClass</span><span class="p">}</span><span class="s2">.</span><span class="p">${</span><span class="nx">targetMethod</span><span class="p">}</span><span class="s2">`</span><span class="p">);</span>

        <span class="c1">// Check if the library is loaded before the method call</span>
        <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="dl">'</span><span class="s1">[INFO] Checking library before method call:</span><span class="dl">'</span><span class="p">);</span>
        <span class="nx">isLibraryLoaded</span><span class="p">(</span><span class="nx">libraryName</span><span class="p">);</span>

        <span class="c1">// Call the original method and capture the return value</span>
        <span class="kd">var</span> <span class="nx">result</span> <span class="o">=</span> <span class="k">this</span><span class="p">[</span><span class="nx">targetMethod</span><span class="p">](</span><span class="nx">arg0</span><span class="p">);</span>

        <span class="c1">// Check if the library is loaded after the method call</span>
        <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="dl">'</span><span class="s1">[INFO] Checking library after method call:</span><span class="dl">'</span><span class="p">);</span>
        <span class="nx">isLibraryLoaded</span><span class="p">(</span><span class="nx">libraryName</span><span class="p">);</span>

        <span class="k">return</span> <span class="nx">result</span><span class="p">;</span>
    <span class="p">};</span>
<span class="p">});</span>
</code></pre></div></div>

<h2 id="conclusion">Conclusion</h2>

        
      </section>

      <footer class="page__meta">
        
        


        

  <p class="page__date"><strong><i class="fas fa-fw fa-calendar-alt" aria-hidden="true"></i> Updated:</strong> <time class="dt-published" datetime="2024-07-25T08:00:00-04:00">July 25, 2024</time></p>

      </footer>

      

      
    </div>

    
  </article>

  
  
</div>

      
    </div>

    

    <div id="footer" class="page__footer">
      <footer>
        <!-- start custom footer snippets -->

<!-- end custom footer snippets -->
        <div class="page__footer-follow">
  <ul class="social-icons">
    

    

    
      <li><a href="/feed.xml"><i class="fas fa-fw fa-rss-square" aria-hidden="true"></i> Feed</a></li>
    
  </ul>
</div>

<div class="page__footer-copyright">&copy; 2024 <a href="http://localhost:4000">Desktop and Mobile Malware Analysis</a>. Powered by <a href="https://jekyllrb.com" rel="nofollow">Jekyll</a> &amp; <a href="https://mademistakes.com/work/minimal-mistakes-jekyll-theme/" rel="nofollow">Minimal Mistakes</a>.</div>

      </footer>
    </div>

    
  <script src="/assets/js/main.min.js"></script>









  </body>
</html>
